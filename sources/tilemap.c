#include "tilemap.h"
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

// Layer 1 data - base layer
static const int l_New_Layer_1[MAP_HEIGHT][MAP_WIDTH] = {
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,249,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,275,299,299,299,299,299},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,248,299,299,299,299,299},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,276,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355}
};

// Layer 3 data - decorative layer
static const int l_New_Layer_2[MAP_HEIGHT][MAP_WIDTH] = {
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,0},
   {0,0,0,0,0,5,6,7,8,0,0,0,0,0,0,0,0,0,0,0,5,6,7,8,0},
   {0,0,0,0,0,9,10,11,12,0,0,0,0,0,0,0,0,0,0,0,9,10,11,12,0},
   {0,0,0,0,0,13,14,15,16,0,0,0,0,0,0,0,0,0,0,0,13,14,15,16,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,1,2,3,4,0,0,0,0,0,0,0,0,1,2,3,4,0},
   {0,0,0,0,0,0,0,0,5,6,7,8,0,0,0,0,0,0,0,0,5,6,7,8,0},
   {0,0,0,0,0,0,0,0,9,10,11,12,0,0,0,0,0,0,0,0,9,10,11,12,0},
   {0,0,0,0,0,0,0,0,13,14,15,16,0,0,0,0,0,0,0,0,13,14,15,16,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

// Layer 4 data - top decorative layer
static const int l_New_Layer_3[MAP_HEIGHT][MAP_WIDTH] = {
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,43,44,45},
   {0,0,0,0,0,0,0,0,0,147,148,0,0,0,0,0,0,0,0,0,0,0,56,57,58},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,70,71},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,41,42,0,0,0,0,0,0},
   {0,40,41,42,0,0,0,0,0,0,0,0,0,0,0,0,53,54,55,0,0,0,0,0,0},
   {0,53,54,55,0,0,0,0,0,0,0,0,0,149,150,0,66,67,68,0,0,0,0,0,0},
   {0,66,67,68,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,43,44,45,0,0,1,2,3,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,56,57,58,0,0,14,15,16,0,0,0,0,0,0,0,0,0,0},
   {0,149,150,0,0,0,0,69,70,71,0,0,27,28,29,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,40,41,42,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,53,54,55,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,66,67,68,0,0,0,0,0,0,0,0,147,148,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,40,41,42,0,0,0,147,148,0,0,0,0,43,44,45,147,148,0,40,41,42,0,0},
   {0,0,53,54,55,0,0,0,0,0,0,0,0,0,56,57,58,0,0,0,53,54,55,0,0},
   {0,0,66,67,68,0,0,0,0,0,0,0,0,0,69,70,71,0,0,0,66,67,68,0,0}
};

// Initialize a tilemap with the layer data
Tilemap InitTilemap(void) {
    Tilemap map;
    map.tileSize = TILE_SIZE;
    map.mapWidth = MAP_WIDTH;
    map.mapHeight = MAP_HEIGHT;

    // Load the tileset textures for each layer
    map.tileset1 = LoadTexture(ASSETS_PATH "images/83291578-f8ec-4e3f-2f6a-6a248efa5800.png");
    map.tileset3 = LoadTexture(ASSETS_PATH "images/61226b83-964f-466c-c64c-94852f980500.png");
    map.tileset4 = LoadTexture(ASSETS_PATH "images/bb5eb52a-6c5d-4e83-72e7-a62c7ac8ea00.png");

    // Copy layer data
    memcpy(map.layer1, l_New_Layer_1, sizeof(l_New_Layer_1));
    memcpy(map.layer3, l_New_Layer_2, sizeof(l_New_Layer_2));
    memcpy(map.layer4, l_New_Layer_3, sizeof(l_New_Layer_3));

    return map;
}

// Draw a single layer
void DrawLayer(const Tilemap* map, int layer[MAP_HEIGHT][MAP_WIDTH], const Texture2D tileset) {
    // Draw all tiles (no camera culling)
    int startX = 0;
    int startY = 0;
    int endX = map->mapWidth;
    int endY = map->mapHeight;

    // Calculate tiles per row in tileset (using ceiling division like JavaScript)
    int tilesPerRow = (tileset.width + map->tileSize - 1) / map->tileSize;

    // Draw visible tiles
    for (int y = startY; y < endY; y++) {
        for (int x = startX; x < endX; x++) {
            int tileIndex = layer[y][x];

            // Skip empty tiles (0 means no tile)
            if (tileIndex == 0) continue;

            // Convert 1-based index to 0-based
            tileIndex -= 1;

            // Calculate source position in tileset
            int srcX = (tileIndex % tilesPerRow) * map->tileSize;
            int srcY = (tileIndex / tilesPerRow) * map->tileSize;

            Rectangle source = {
                srcX,
                srcY,
                map->tileSize,
                map->tileSize
            };

            Rectangle dest = {
                x * map->tileSize,
                y * map->tileSize,
                map->tileSize,
                map->tileSize
            };

            DrawTexturePro(tileset, source, dest, (Vector2){0, 0}, 0.0f, WHITE);
        }
    }
}

// Draw the tilemap (all layers)
void DrawTilemap(Tilemap* map) {
    DrawLayer(map, map->layer1, map->tileset1);
    DrawLayer(map, map->layer3, map->tileset3);
    DrawLayer(map, map->layer4, map->tileset4);
}

// Unload tilemap resources
void UnloadTilemap(const Tilemap* map) {
    UnloadTexture(map->tileset1);
    UnloadTexture(map->tileset3);
    UnloadTexture(map->tileset4);
}
