#include "tilemap.h"
#include <string.h>

// Layer 1 data - base layer
static const int l_New_Layer_1[MAP_HEIGHT][MAP_WIDTH] = {
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,249,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,275,299,299,299,299,299},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,248,299,299,299,299,299},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,274,355,355,355,355,355},
   {299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,299,276,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355},
   {355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355,355}
};

// Layer 2 data - decorative layer
static const int l_New_Layer_5[MAP_HEIGHT][MAP_WIDTH] = {
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,0},
   {0,0,0,0,0,5,6,7,8,0,0,0,0,0,0,0,0,0,0,0,5,6,7,8,0},
   {0,0,0,0,0,9,10,11,12,0,0,0,0,0,0,0,0,0,0,0,9,10,11,12,0},
   {0,0,0,0,0,13,14,15,16,0,0,0,0,0,0,0,0,0,0,0,13,14,15,16,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,1,2,3,4,0,0,0,0,0,0,0,0,1,2,3,4,0},
   {0,0,0,0,0,0,0,0,5,6,7,8,0,0,0,0,0,0,0,0,5,6,7,8,0},
   {0,0,0,0,0,0,0,0,9,10,11,12,0,0,0,0,0,0,0,0,9,10,11,12,0},
   {0,0,0,0,0,0,0,0,13,14,15,16,0,0,0,0,0,0,0,0,13,14,15,16,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

// Layer 3 data - top decorative layer
static const int l_New_Layer_2[MAP_HEIGHT][MAP_WIDTH] = {
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,43,44,45},
   {0,0,0,0,0,0,0,0,0,147,148,0,0,0,0,0,0,0,0,0,0,0,56,57,58},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,70,71},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,41,42,0,0,0,0,0,0},
   {0,40,41,42,0,0,0,0,0,0,0,0,0,0,0,0,53,54,55,0,0,0,0,0,0},
   {0,53,54,55,0,0,0,0,0,0,0,0,0,149,150,0,66,67,68,0,0,0,0,0,0},
   {0,66,67,68,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,43,44,45,0,0,1,2,3,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,56,57,58,0,0,14,15,16,0,0,0,0,0,0,0,0,0,0},
   {0,149,150,0,0,0,0,69,70,71,0,0,27,28,29,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,40,41,42,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,53,54,55,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,66,67,68,0,0,0,0,0,0,0,0,147,148,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
   {0,0,40,41,42,0,0,0,147,148,0,0,0,0,43,44,45,147,148,0,40,41,42,0,0},
   {0,0,53,54,55,0,0,0,0,0,0,0,0,0,56,57,58,0,0,0,53,54,55,0,0},
   {0,0,66,67,68,0,0,0,0,0,0,0,0,0,69,70,71,0,0,0,66,67,68,0,0}
};

// Initialize a tilemap with the layer data
TILE_MAP init_tilemap(void) {
    TILE_MAP map;
    map.tile_size = TILE_SIZE;
    map.map_width = MAP_WIDTH;
    map.map_height = MAP_HEIGHT;

    // Load the tileset textures for each layer
    map.tileset1 = LoadTexture(ASSETS_PATH "images/83291578-f8ec-4e3f-2f6a-6a248efa5800.png");
    map.tileset2 = LoadTexture(ASSETS_PATH "images/bb5eb52a-6c5d-4e83-72e7-a62c7ac8ea00.png");

    // Copy layer data
    memcpy(map.layer1, l_New_Layer_1, sizeof(l_New_Layer_1));
    memcpy(map.layer2, l_New_Layer_2, sizeof(l_New_Layer_2));

    return map;
}

// Draw a single layer
void draw_layer(const TILE_MAP* map, int layer[MAP_HEIGHT][MAP_WIDTH], const Texture2D tileset) {

    for (int y = 0; y < map->map_height; y++) {
        for (int x = 0; x < map->map_width; x++) {
            int tile_index = layer[y][x];

            if (tile_index == 0) continue;

            tile_index -= 1;

            draw_texture(map,tileset,tile_index,x,y);
        }
    }
}
int tiles_per_row(const TILE_MAP* map, const Texture2D tileset) {
    return (tileset.width + map->tile_size - 1) / map->tile_size;
}

void draw_texture(const TILE_MAP* map, const Texture2D tileset, const int tile_index, const int x, const int y) {

    const int scaled_tile_size = get_tile_scale(map);

    const int tiles_per_row_v = tiles_per_row(map,tileset);

    const int src_x = (tile_index % tiles_per_row_v) * map->tile_size;
    const int src_y = (tile_index / tiles_per_row_v) * map->tile_size;

    const Rectangle source = {
        (float)src_x,
        (float)src_y,
        (float)map->tile_size,
        (float)map->tile_size
    };

    const Rectangle dest = {
        (float)(x * scaled_tile_size),
        (float)(y * scaled_tile_size),
        (float) scaled_tile_size,
        (float) scaled_tile_size
    };

    DrawTexturePro(tileset, source, dest, (Vector2){0, 0}, 0.0f, WHITE);
}

void draw_tilemap(TILE_MAP* map) {
    draw_layer(map, map->layer1, map->tileset1);
    draw_layer(map, map->layer2, map->tileset2);
}

void unload_tilemap(const TILE_MAP* map) {
    UnloadTexture(map->tileset1);
    UnloadTexture(map->tileset2);
}
int get_tile_scale(const TILE_MAP* map) {
    const int screen_width = GetScreenWidth();
    const int screen_height = GetScreenHeight();

    const int map_pixel_width = map->map_width * map->tile_size;
    const int map_pixel_height = map->map_height * map->tile_size;

    const int scale_x = screen_width / map_pixel_width;
    const int scale_y = screen_height / map_pixel_height;
    const int scale = scale_x < scale_y ? scale_x : scale_y; // Use smaller scale to fit

    return map->tile_size * scale;
}
